<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GRASIAS - ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ù…ØªØ·ÙˆØ±</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<style>
* {
box-sizing: border-box;
}

body {
font-family: 'Cairo', sans-serif;
background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
margin: 0;
min-height: 100vh;
display: flex;
align-items: center;
justify-content: center;
direction: rtl;
padding: 20px;
position: relative;
overflow-x: hidden;
}

/* Enhanced animated background */
body::before {
content: '';
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: 
  radial-gradient(circle at 20% 80%, rgba(120, 119, 198, 0.3) 0%, transparent 50%),
  radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
  radial-gradient(circle at 40% 40%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
animation: backgroundMove 20s ease-in-out infinite;
z-index: -1;
}

@keyframes backgroundMove {
0%, 100% { transform: translateX(0) translateY(0); }
33% { transform: translateX(-30px) translateY(-30px); }
66% { transform: translateX(30px) translateY(-30px); }
}

.box {
background: rgba(255, 255, 255, 0.95);
backdrop-filter: blur(20px);
padding: 35px 30px;
border-radius: 25px;
box-shadow: 
  0 25px 60px rgba(0,0,0,0.15),
  0 0 0 1px rgba(255,255,255,0.2);
width: 100%;
max-width: 420px;
text-align: center;
animation: fadeInUp 0.8s cubic-bezier(0.25, 0.46, 0.45, 0.94);
border: 1px solid rgba(255,255,255,0.2);
}

@keyframes fadeInUp {
from {
opacity: 0;
transform: translateY(40px) scale(0.95);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}

h2 {
margin-bottom: 30px;
color: #2d3748;
font-weight: 700;
font-size: 28px;
background: linear-gradient(135deg, #667eea, #764ba2);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

input, button, textarea, select {
width: 100%;
padding: 18px 20px;
border-radius: 15px;
margin-bottom: 18px;
font-size: 16px;
border: 2px solid rgba(102, 126, 234, 0.1);
transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
font-family: 'Cairo', sans-serif;
background: rgba(255,255,255,0.8);
backdrop-filter: blur(10px);
}

input:focus, textarea:focus, select:focus {
border-color: #667eea;
outline: none;
box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15);
background: rgba(255,255,255,0.95);
transform: translateY(-2px);
}

button {
background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
color: white;
border: none;
cursor: pointer;
font-weight: 600;
transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
position: relative;
overflow: hidden;
}

button::before {
content: '';
position: absolute;
top: 0;
left: -100%;
width: 100%;
height: 100%;
background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
transition: left 0.5s;
}

button:hover::before {
left: 100%;
}

button:hover {
transform: translateY(-3px);
box-shadow: 0 15px 35px rgba(102, 126, 234, 0.4);
}

button:active {
transform: translateY(-1px);
}

.choice {
text-align: right;
margin: 30px 0;
}

.choice label {
display: flex;
align-items: center;
margin-bottom: 15px;
font-size: 17px;
cursor: pointer;
padding: 15px;
border-radius: 12px;
transition: all 0.3s ease;
background: rgba(102, 126, 234, 0.05);
border: 2px solid transparent;
}

.choice label:hover {
background: rgba(102, 126, 234, 0.1);
border-color: rgba(102, 126, 234, 0.2);
transform: translateX(-5px);
}

.choice input[type="radio"] {
margin-left: 12px;
width: 20px;
height: 20px;
accent-color: #667eea;
}

/* Enhanced map and sidebar styles */
#mapPage {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
z-index: 100;
background: #f7fafc;
}

#map {
width: 70%;
height: 100%;
float: right;
border-radius: 0 0 0 25px;
box-shadow: -5px 0 25px rgba(0,0,0,0.1);
}

.sidebar {
width: 30%;
height: 100%;
background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(247,250,252,0.95) 100%);
backdrop-filter: blur(20px);
padding: 25px;
overflow-y: auto;
box-shadow: 5px 0 25px rgba(0,0,0,0.1);
border-right: 1px solid rgba(102, 126, 234, 0.1);
}

.sidebar h3 {
color: #2d3748;
font-size: 22px;
font-weight: 700;
margin-bottom: 25px;
padding-bottom: 15px;
border-bottom: 2px solid rgba(102, 126, 234, 0.1);
background: linear-gradient(135deg, #667eea, #764ba2);
-webkit-background-clip: text;
-webkit-text-fill-color: transparent;
background-clip: text;
}

/* Enhanced chat container with modern design */
.chat-container {
position: fixed;
bottom: 25px;
right: 25px;
width: 350px;
height: 450px;
background: rgba(255,255,255,0.95);
backdrop-filter: blur(20px);
border-radius: 20px;
box-shadow: 
  0 25px 60px rgba(0,0,0,0.15),
  0 0 0 1px rgba(255,255,255,0.2);
display: none;
flex-direction: column;
z-index: 1000;
border: 1px solid rgba(102, 126, 234, 0.1);
animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

@keyframes slideInUp {
from {
opacity: 0;
transform: translateY(30px) scale(0.95);
}
to {
opacity: 1;
transform: translateY(0) scale(1);
}
}

.chat-header {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
padding: 20px;
border-radius: 20px 20px 0 0;
display: flex;
justify-content: space-between;
align-items: center;
font-weight: 600;
box-shadow: 0 2px 10px rgba(102, 126, 234, 0.2);
}

.chat-messages {
flex: 1;
padding: 20px;
overflow-y: auto;
max-height: 280px;
}

.chat-input-container {
padding: 20px;
border-top: 1px solid rgba(102, 126, 234, 0.1);
display: flex;
gap: 12px;
background: rgba(247,250,252,0.5);
border-radius: 0 0 20px 20px;
}

.chat-input {
flex: 1;
padding: 12px 16px;
border: 2px solid rgba(102, 126, 234, 0.1);
border-radius: 12px;
margin: 0;
background: white;
transition: all 0.3s ease;
}

.chat-input:focus {
border-color: #667eea;
box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.send-btn {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
border: none;
padding: 12px 20px;
border-radius: 12px;
cursor: pointer;
margin: 0;
width: auto;
font-weight: 600;
transition: all 0.3s ease;
}

.send-btn:hover {
transform: translateY(-2px);
box-shadow: 0 8px 20px rgba(102, 126, 234, 0.3);
}

/* Enhanced message bubbles */
.message {
margin-bottom: 15px;
padding: 12px 18px;
border-radius: 18px;
max-width: 85%;
position: relative;
animation: messageSlide 0.3s ease;
word-wrap: break-word;
}

@keyframes messageSlide {
from {
opacity: 0;
transform: translateY(10px);
}
to {
opacity: 1;
transform: translateY(0);
}
}

.message.sent {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
margin-left: auto;
text-align: left;
border-bottom-right-radius: 5px;
box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.message.received {
background: rgba(247,250,252,0.8);
color: #2d3748;
margin-right: auto;
border-bottom-left-radius: 5px;
border: 1px solid rgba(102, 126, 234, 0.1);
}

/* Enhanced trip status and controls */
.trip-status {
background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
border: 2px solid rgba(102, 126, 234, 0.2);
border-radius: 15px;
padding: 20px;
margin-bottom: 20px;
text-align: center;
backdrop-filter: blur(10px);
}

.trip-controls {
display: flex;
gap: 10px;
margin: 15px 0;
flex-wrap: wrap;
}

.trip-controls button {
flex: 1;
min-width: 120px;
padding: 12px 16px;
font-size: 14px;
border-radius: 12px;
font-weight: 600;
transition: all 0.3s ease;
}

.cancel-btn {
background: linear-gradient(135deg, #e53e3e, #c53030) !important;
}

.cancel-btn:hover {
box-shadow: 0 8px 20px rgba(229, 62, 62, 0.3) !important;
}

.pickup-btn {
background: linear-gradient(135deg, #38a169, #2f855a) !important;
}

.pickup-btn:hover {
box-shadow: 0 8px 20px rgba(56, 161, 105, 0.3) !important;
}

.complete-btn {
background: linear-gradient(135deg, #3182ce, #2c5282) !important;
}

.complete-btn:hover {
box-shadow: 0 8px 20px rgba(49, 130, 206, 0.3) !important;
}

/* Star rating system */
.rating-container {
background: rgba(255,255,255,0.95);
backdrop-filter: blur(20px);
border-radius: 20px;
padding: 30px;
margin: 20px 0;
box-shadow: 0 15px 35px rgba(0,0,0,0.1);
border: 1px solid rgba(102, 126, 234, 0.1);
}

.star-rating {
display: flex;
justify-content: center;
gap: 8px;
margin: 20px 0;
}

.star {
font-size: 32px;
color: #e2e8f0;
cursor: pointer;
transition: all 0.3s ease;
}

.star:hover,
.star.active {
color: #ffd700;
transform: scale(1.1);
text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.rating-comment {
width: 100%;
min-height: 80px;
padding: 15px;
border: 2px solid rgba(102, 126, 234, 0.1);
border-radius: 12px;
resize: vertical;
font-family: 'Cairo', sans-serif;
background: rgba(255,255,255,0.8);
}

/* Enhanced driver cards */
.driver-card {
background: rgba(255,255,255,0.95);
backdrop-filter: blur(10px);
border-radius: 15px;
padding: 20px;
margin-bottom: 15px;
border: 2px solid rgba(102, 126, 234, 0.1);
transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

.driver-card:hover {
transform: translateY(-5px);
box-shadow: 0 15px 35px rgba(102, 126, 234, 0.15);
border-color: rgba(102, 126, 234, 0.3);
}

.driver-info {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 15px;
}

.driver-name {
font-weight: 700;
font-size: 18px;
color: #2d3748;
}

.driver-distance {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
padding: 5px 12px;
border-radius: 20px;
font-size: 12px;
font-weight: 600;
}

.driver-actions {
display: flex;
gap: 8px;
}

.driver-actions button {
flex: 1;
padding: 10px 15px;
font-size: 13px;
border-radius: 10px;
margin: 0;
}

/* Enhanced notifications */
.notification {
position: fixed;
top: 20px;
right: 20px;
background: rgba(255,255,255,0.95);
backdrop-filter: blur(20px);
border-radius: 15px;
padding: 20px;
box-shadow: 0 15px 35px rgba(0,0,0,0.15);
border: 1px solid rgba(102, 126, 234, 0.2);
z-index: 2000;
min-width: 300px;
animation: slideInRight 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
}

@keyframes slideInRight {
from {
opacity: 0;
transform: translateX(100px);
}
to {
opacity: 1;
transform: translateX(0);
}
}

.notification-title {
font-weight: 700;
font-size: 16px;
color: #2d3748;
margin-bottom: 10px;
}

.notification-content {
color: #4a5568;
margin-bottom: 15px;
line-height: 1.5;
}

.notification-actions {
display: flex;
gap: 10px;
}

.accept-btn {
background: linear-gradient(135deg, #38a169, #2f855a) !important;
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
flex: 1;
}

.reject-btn {
background: linear-gradient(135deg, #e53e3e, #c53030) !important;
color: white;
border: none;
padding: 10px 20px;
border-radius: 8px;
cursor: pointer;
font-weight: 600;
flex: 1;
}

/* Distance calculator enhancement */
.distance-calculator {
background: rgba(102, 126, 234, 0.05);
border-radius: 15px;
padding: 20px;
margin: 20px 0;
border: 2px solid rgba(102, 126, 234, 0.1);
}

.distance-calculator h4 {
color: #2d3748;
margin-bottom: 15px;
font-weight: 700;
}

.distance-input {
position: relative;
}

.distance-input::after {
content: 'ÙƒÙ…';
position: absolute;
right: 15px;
top: 50%;
transform: translateY(-50%);
color: #718096;
font-weight: 600;
}

.price-display {
background: linear-gradient(135deg, #667eea, #764ba2);
color: white;
padding: 15px;
border-radius: 12px;
margin-top: 15px;
text-align: center;
font-weight: 700;
font-size: 18px;
}

/* Auto distance calculation display */
.auto-distance {
background: rgba(56, 161, 105, 0.1);
border: 2px solid rgba(56, 161, 105, 0.2);
border-radius: 12px;
padding: 15px;
margin: 15px 0;
text-align: center;
}

.auto-distance-value {
font-size: 20px;
font-weight: 700;
color: #2f855a;
}

/* Success and error messages */
.success-message {
background: linear-gradient(135deg, rgba(56, 161, 105, 0.1), rgba(47, 133, 90, 0.1));
border: 2px solid rgba(56, 161, 105, 0.3);
color: #2f855a;
padding: 15px;
border-radius: 12px;
margin: 15px 0;
text-align: center;
font-weight: 600;
}

.error-message {
background: linear-gradient(135deg, rgba(229, 62, 62, 0.1), rgba(197, 48, 48, 0.1));
border: 2px solid rgba(229, 62, 62, 0.3);
color: #c53030;
padding: 15px;
border-radius: 12px;
margin: 15px 0;
text-align: center;
font-weight: 600;
}

/* Mobile responsiveness */
@media (max-width: 768px) {
#map {
width: 100%;
height: 60%;
float: none;
border-radius: 0;
}

.sidebar {
width: 100%;
height: 40%;
position: fixed;
bottom: 0;
border-radius: 25px 25px 0 0;
}

.chat-container {
width: 90%;
height: 70%;
bottom: 50%;
right: 5%;
transform: translateY(50%);
}

.trip-controls {
flex-direction: column;
}

.trip-controls button {
min-width: auto;
}
}

/* Loading animations */
.loading {
display: inline-block;
width: 20px;
height: 20px;
border: 3px solid rgba(255,255,255,.3);
border-radius: 50%;
border-top-color: #fff;
animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
to { transform: rotate(360deg); }
}

/* Pulse animation for active elements */
.pulse {
animation: pulse 2s infinite;
}

@keyframes pulse {
0% {
box-shadow: 0 0 0 0 rgba(102, 126, 234, 0.7);
}
70% {
box-shadow: 0 0 0 10px rgba(102, 126, 234, 0);
}
100% {
box-shadow: 0 0 0 0 rgba(102, 126, 234, 0);
}
}
</style>
</head>
<body>

<!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div id="loginPage" class="box">
<h2>ğŸš— Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ GRASIAS</h2>
<p style="color: #718096; margin-bottom: 25px; font-size: 16px;">ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø­Ù„Ø§Øª Ø§Ù„Ø°ÙƒÙŠ ÙˆØ§Ù„Ù…ØªØ·ÙˆØ±</p>

<div class="choice">
<label>
<input type="radio" name="role" value="rakib">
<i class="fas fa-user" style="margin-left: 10px; color: #667eea;"></i>
Ø±Ø§ÙƒØ¨ - Ø£Ø¨Ø­Ø« Ø¹Ù† Ø±Ø­Ù„Ø©
</label>
<label>
<input type="radio" name="role" value="sayeq">
<i class="fas fa-car" style="margin-left: 10px; color: #667eea;"></i>
Ø³Ø§Ø¦Ù‚ - Ø£Ù‚Ø¯Ù… Ø®Ø¯Ù…Ø© Ø§Ù„Ù†Ù‚Ù„
</label>
</div>

<button onclick="signInWithGoogle()">
<i class="fab fa-google" style="margin-left: 8px;"></i>
ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„
</button>

<div id="successMessage" style="display: none;" class="success-message"></div>
<div id="errorMessage" style="display: none;" class="error-message"></div>
</div>

<!-- ØµÙØ­Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© -->
<div id="mapPage">
<div id="map"></div>
<div class="sidebar">
<div id="tripStatus" class="trip-status" style="display: none;">
<div id="tripStatusText"></div>
<!-- Added trip control buttons -->
<div class="trip-controls" id="tripControls" style="display: none;">
<button class="cancel-btn" onclick="cancelTrip()">
<i class="fas fa-times"></i> Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø±Ø­Ù„Ø©
</button>
<button class="pickup-btn" id="pickupBtn" onclick="confirmPickup()" style="display: none;">
<i class="fas fa-check"></i> ØªÙ… ØªØ±ÙƒÙŠØ¨ Ø§Ù„Ø±Ø§ÙƒØ¨
</button>
<button class="complete-btn" id="completeBtn" onclick="completeTrip()" style="display: none;">
<i class="fas fa-flag-checkered"></i> Ø§ÙƒØªÙ…Ù„Øª Ø§Ù„Ø±Ø­Ù„Ø©
</button>
</div>
</div>

<!-- Auto distance display -->
<div id="autoDistance" class="auto-distance" style="display: none;">
<div>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠØ©</div>
<div class="auto-distance-value" id="autoDistanceValue">0 ÙƒÙ…</div>
<div id="autoPrice" style="margin-top: 10px; font-weight: 600;">Ø§Ù„Ø«Ù…Ù†: 0 Ø¯ÙŠÙ†Ø§Ø±</div>
</div>

<h3 id="sidebarTitle">ğŸš— ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©</h3>

<!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø§ÙƒØ¨ -->
<div id="passengerContent">
<div id="nearbyDrivers">
<h4><i class="fas fa-search"></i> Ø§Ù„Ø³Ø§Ø¦Ù‚ÙˆÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙˆÙ†:</h4>
<div id="driversList"></div>
</div>
</div>

<!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ -->
<div id="driverContent" style="display: none;">
<label><i class="fas fa-toggle-on"></i> Ø­Ø§Ù„Ø© Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
<select id="driverStatus" onchange="updateDriverStatus()">
<option value="available">Ù…ØªØ§Ø­</option>
<option value="busy">Ù…Ø´ØºÙˆÙ„</option>
<option value="offline">ØºÙŠØ± Ù…ØªØµÙ„</option>
</select>

<label><i class="fas fa-users"></i> Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©:</label>
<input type="number" id="availableSeats" min="1" max="8" value="4">

<label><i class="fas fa-sticky-note"></i> Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ø§Ø¦Ù‚:</label>
<textarea id="driverNotes" placeholder="Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù„Ù„Ø±ÙƒØ§Ø¨..." style="height: 60px;"></textarea>

<!-- Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„Ø«Ù…Ù† -->
<div class="distance-calculator">
<h4><i class="fas fa-calculator"></i> Ø­Ø§Ø³Ø¨Ø© Ø§Ù„Ø«Ù…Ù†:</h4>
<div class="distance-input">
<input type="number" id="distanceInput" placeholder="Ø§Ù„Ù…Ø³Ø§ÙØ© (ÙƒÙ…)" min="1" onchange="calculatePrice()">
</div>
<div id="priceDisplay" class="price-display" style="display: none;">
<i class="fas fa-money-bill-wave"></i> Ø§Ù„Ø«Ù…Ù†: <span id="calculatedPrice">0</span> Ø¯ÙŠÙ†Ø§Ø±
</div>
</div>
</div>

<button onclick="activateRide()" id="activateBtn" class="pulse">
<i class="fas fa-play"></i> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø±Ø­Ù„Ø©
</button>
<button onclick="logout()" style="background: linear-gradient(135deg, #e53e3e, #c53030); margin-top: 10px;">
<i class="fas fa-sign-out-alt"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
</button>

<!-- Chat toggle button -->
<button onclick="toggleChat()" style="background: linear-gradient(135deg, #38a169, #2f855a); margin-top: 10px;">
<i class="fas fa-comments"></i> ÙØªØ­ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
</button>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ù…Ø­Ø³Ù†Ø© -->
<div id="chatContainer" class="chat-container">
<div class="chat-header">
<span id="chatTitle"><i class="fas fa-comments"></i> Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</span>
<button onclick="closeChat()" style="background: none; border: none; color: white; cursor: pointer; padding: 5px; margin: 0; width: auto; border-radius: 50%; transition: all 0.3s ease;">
<i class="fas fa-times"></i>
</button>
</div>
<div id="chatMessages" class="chat-messages"></div>
<div class="chat-input-container">
<input type="text" id="chatInput" class="chat-input" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." onkeypress="handleChatKeyPress(event)">
<button onclick="sendMessage()" class="send-btn">
<i class="fas fa-paper-plane"></i>
</button>
</div>
</div>

<!-- Rating modal -->
<div id="ratingModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; backdrop-filter: blur(5px);">
<div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 90%; max-width: 400px;">
<div class="rating-container">
<h3 style="text-align: center; color: #2d3748; margin-bottom: 20px;">
<i class="fas fa-star" style="color: #ffd700;"></i> Ù‚ÙŠÙ… Ø§Ù„Ø³Ø§Ø¦Ù‚
</h3>
<div class="star-rating" id="starRating">
<span class="star" onclick="setRating(1)" data-rating="1">â˜…</span>
<span class="star" onclick="setRating(2)" data-rating="2">â˜…</span>
<span class="star" onclick="setRating(3)" data-rating="3">â˜…</span>
<span class="star" onclick="setRating(4)" data-rating="4">â˜…</span>
<span class="star" onclick="setRating(5)" data-rating="5">â˜…</span>
</div>
<textarea class="rating-comment" id="ratingComment" placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¦Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)..."></textarea>
<div style="display: flex; gap: 10px; margin-top: 20px;">
<button onclick="submitRating()" style="flex: 1; background: linear-gradient(135deg, #38a169, #2f855a);">
<i class="fas fa-check"></i> Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
</button>
<button onclick="closeRatingModal()" style="flex: 1; background: linear-gradient(135deg, #718096, #4a5568);">
<i class="fas fa-times"></i> ØªØ®Ø·ÙŠ
</button>
</div>
</div>
</div>
</div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>

<script>
const firebaseConfig = {
    apiKey: "AIzaSyBvOyeRxIloglkmpolnHFfv2DD_6BbOk-0",
    authDomain: "grasias-app.firebaseapp.com",
    databaseURL: "https://grasias-app-default-rtdb.firebaseio.com/",
    projectId: "grasias-app",
    storageBucket: "grasias-app.appspot.com",
    messagingSenderId: "123456789",
    appId: "1:123456789:web:abcdef123456"
};

// ØªÙ‡ÙŠØ¦Ø© Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const database = firebase.database();

function signInWithGoogle() {
    const roleInput = document.querySelector('input[name="role"]:checked');
    if (!roleInput) {
        showMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹', 'error');
        return;
    }

    const selectedRole = roleInput.value;
    const loginBtn = document.querySelector('button');
    loginBtn.innerHTML = '<span class="loading"></span> Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
    loginBtn.disabled = true;

    const provider = new firebase.auth.GoogleAuthProvider();
    
    auth.signInWithPopup(provider)
        .then((result) => {
            const user = result.user;
            window.currentUser = {
                uid: user.uid,
                displayName: user.displayName,
                email: user.email,
                photoURL: user.photoURL
            };
            window.currentRole = selectedRole;
            
            // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
            database.ref('users/' + user.uid).set({
                name: user.displayName,
                email: user.email,
                role: selectedRole,
                photoURL: user.photoURL,
                lastActive: firebase.database.ServerValue.TIMESTAMP,
                status: selectedRole === 'sayeq' ? 'offline' : 'active'
            });
            
            showMessage('ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
            setTimeout(() => {
                document.getElementById('loginPage').style.display = 'none';
                document.getElementById('mapPage').style.display = 'block';
                loadMap(user.displayName);
                setupUserInterface();
                
                if (selectedRole === 'rakib') {
                    loadRealDrivers();
                }
            }, 1500);
        })
        .catch((error) => {
            console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:', error);
            showMessage('ÙØ´Ù„ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ' + error.message, 'error');
            loginBtn.innerHTML = '<i class="fab fa-google" style="margin-left: 8px;"></i>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ø¬ÙˆØ¬Ù„';
            loginBtn.disabled = false;
        });
}

function activateRide() {
    if (window.currentRole === 'rakib') {
        loadRealDrivers();
        showNotification('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¨Ø­Ø«', 'Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø§Ù„Ù‚Ø±ÙŠØ¨ÙŠÙ†...', 'info');
    } else {
        // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø³Ø§Ø¦Ù‚ ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const driverData = {
            name: window.currentUser.displayName,
            email: window.currentUser.email,
            photoURL: window.currentUser.photoURL,
            status: 'available',
            location: window.currentLocation,
            availableSeats: document.getElementById('availableSeats').value,
            notes: document.getElementById('driverNotes').value,
            rating: 4.5, // ØªÙ‚ÙŠÙŠÙ… Ø§ÙØªØ±Ø§Ø¶ÙŠ
            car: 'Ø³ÙŠØ§Ø±Ø© Ø®Ø§ØµØ©',
            lastActive: firebase.database.ServerValue.TIMESTAMP
        };
        
        database.ref('activeDrivers/' + window.currentUser.uid).set(driverData)
            .then(() => {
                document.getElementById('driverStatus').value = 'available';
                showNotification('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©', 'Ø£Ù†Øª Ø§Ù„Ø¢Ù† Ù…ØªØ§Ø­ Ù„Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª', 'success');
                
                // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø±Ø­Ù„Ø§Øª
                listenForTripRequests();
            })
            .catch((error) => {
                showNotification('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø®Ø¯Ù…Ø©: ' + error.message, 'error');
            });
    }
}

function loadRealDrivers() {
    database.ref('activeDrivers').orderByChild('status').equalTo('available')
        .on('value', (snapshot) => {
            const drivers = [];
            snapshot.forEach((childSnapshot) => {
                const driver = childSnapshot.val();
                const driverId = childSnapshot.key;
                
                if (driverId !== window.currentUser.uid && driver.location) {
                    const distance = calculateDistance(
                        window.currentLocation.lat, window.currentLocation.lng,
                        driver.location.lat, driver.location.lng
                    );
                    
                    drivers.push({
                        id: driverId,
                        name: driver.name,
                        rating: driver.rating || 4.5,
                        car: driver.car || 'Ø³ÙŠØ§Ø±Ø© Ø®Ø§ØµØ©',
                        photoURL: driver.photoURL,
                        lat: driver.location.lat,
                        lng: driver.location.lng,
                        distance: distance,
                        availableSeats: driver.availableSeats || 4,
                        notes: driver.notes || ''
                    });
                }
            });
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø³Ø§Ø¦Ù‚ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©
            drivers.sort((a, b) => a.distance - b.distance);
            window.drivers = drivers;
            displayDrivers(drivers);
        });
}

function displayDrivers(drivers) {
    const driversContainer = document.getElementById('driversList');
    driversContainer.innerHTML = '';
    
    if (drivers.length === 0) {
        driversContainer.innerHTML = `
            <div style="text-align: center; padding: 20px; color: #718096;">
                <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
                <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø§Ø¦Ù‚ÙˆÙ† Ù…ØªØ§Ø­ÙˆÙ† ÙÙŠ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ø­Ø§Ù„ÙŠ</p>
                <button onclick="loadRealDrivers()" style="margin-top: 10px; background: #667eea;">
                    <i class="fas fa-refresh"></i> Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø­Ø«
                </button>
            </div>
        `;
        return;
    }
    
    drivers.forEach(driver => {
        const price = calculatePrice(driver.distance);
        const driverCard = document.createElement('div');
        driverCard.className = 'driver-card';
        driverCard.innerHTML = `
            <div class="driver-info">
                <div style="display: flex; align-items: center; margin-bottom: 10px;">
                    <img src="${driver.photoURL || '/placeholder.svg?height=40&width=40'}" 
                         alt="${driver.name}" 
                         style="width: 40px; height: 40px; border-radius: 50%; margin-left: 10px;">
                    <div>
                        <div class="driver-name">${driver.name}</div>
                        <div style="color: #ffd700; margin: 2px 0;">
                            ${'â˜…'.repeat(Math.floor(driver.rating))} ${driver.rating}
                        </div>
                    </div>
                </div>
                <div style="color: #718096; font-size: 14px; margin-bottom: 5px;">${driver.car}</div>
                <div style="color: #718096; font-size: 12px; margin-bottom: 8px;">Ø§Ù„Ù…Ù‚Ø§Ø¹Ø¯ Ø§Ù„Ù…ØªØ§Ø­Ø©: ${driver.availableSeats}</div>
                ${driver.notes ? `<div style="color: #4a5568; font-size: 12px; margin-bottom: 8px;">${driver.notes}</div>` : ''}
                <div style="color: #2d3748; font-weight: 600; margin-bottom: 5px;">
                    Ø§Ù„Ù…Ø³Ø§ÙØ©: ${driver.distance.toFixed(1)} ÙƒÙ…
                </div>
                <div style="color: #38a169; font-weight: 700; font-size: 16px;">
                    Ø§Ù„Ø³Ø¹Ø±: ${price.toLocaleString()} Ø¯ÙŠÙ†Ø§Ø±
                </div>
            </div>
            <div class="driver-actions">
                <button onclick="requestRide('${driver.id}')" style="background: linear-gradient(135deg, #667eea, #764ba2);">
                    <i class="fas fa-car"></i> Ø·Ù„Ø¨ Ø±Ø­Ù„Ø©
                </button>
                <button onclick="openChat('${driver.id}', '${driver.name}')" style="background: linear-gradient(135deg, #38a169, #2f855a);">
                    <i class="fas fa-comments"></i> Ø¯Ø±Ø¯Ø´Ø©
                </button>
            </div>
        `;
        driversContainer.appendChild(driverCard);
    });
}

function listenForTripRequests() {
    database.ref('tripRequests').orderByChild('driverId').equalTo(window.currentUser.uid)
        .on('child_added', (snapshot) => {
            const tripRequest = snapshot.val();
            if (tripRequest.status === 'requested') {
                showTripRequestNotification(tripRequest, snapshot.key);
            }
        });
}

function showTripRequestNotification(tripRequest, requestId) {
    const notification = document.createElement('div');
    notification.className = 'trip-request-notification';
    notification.innerHTML = `
        <div style="background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); max-width: 400px;">
            <h3 style="color: #2d3748; margin-bottom: 15px;">
                <i class="fas fa-bell"></i> Ø·Ù„Ø¨ Ø±Ø­Ù„Ø© Ø¬Ø¯ÙŠØ¯
            </h3>
            <p><strong>Ø§Ù„Ø±Ø§ÙƒØ¨:</strong> ${tripRequest.passengerName}</p>
            <p><strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${tripRequest.distance.toFixed(1)} ÙƒÙ…</p>
            <p><strong>Ø§Ù„Ø³Ø¹Ø±:</strong> ${tripRequest.price.toLocaleString()} Ø¯ÙŠÙ†Ø§Ø±</p>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="acceptTripRequest('${requestId}')" 
                        style="background: #38a169; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-check"></i> Ù‚Ø¨ÙˆÙ„
                </button>
                <button onclick="rejectTripRequest('${requestId}')" 
                        style="background: #e53e3e; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer;">
                    <i class="fas fa-times"></i> Ø±ÙØ¶
                </button>
            </div>
        </div>
    `;
    
    document.body.appendChild(notification);
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ 30 Ø«Ø§Ù†ÙŠØ©
    setTimeout(() => {
        if (notification.parentNode) {
            notification.parentNode.removeChild(notification);
        }
    }, 30000);
}

function acceptTripRequest(requestId) {
    database.ref('tripRequests/' + requestId).update({
        status: 'accepted',
        acceptedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showNotification('ØªÙ… Ø§Ù„Ù‚Ø¨ÙˆÙ„', 'ØªÙ… Ù‚Ø¨ÙˆÙ„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const notification = document.querySelector('.trip-request-notification');
        if (notification) notification.remove();
    });
}

function rejectTripRequest(requestId) {
    database.ref('tripRequests/' + requestId).update({
        status: 'rejected',
        rejectedAt: firebase.database.ServerValue.TIMESTAMP
    }).then(() => {
        showNotification('ØªÙ… Ø§Ù„Ø±ÙØ¶', 'ØªÙ… Ø±ÙØ¶ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©', 'info');
        // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±
        const notification = document.querySelector('.trip-request-notification');
        if (notification) notification.remove();
    });
}

function requestRide(driverId) {
    if (!window.currentLocation) {
        showNotification('Ø®Ø·Ø£', 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ', 'error');
        return;
    }

    const driver = window.drivers.find(d => d.id === driverId);
    if (!driver) return;

    const distance = driver.distance;
    const price = calculatePrice(distance);

    const tripRequest = {
        passengerId: window.currentUser.uid,
        passengerName: window.currentUser.displayName,
        driverId: driverId,
        driverName: driver.name,
        status: 'requested',
        timestamp: firebase.database.ServerValue.TIMESTAMP,
        passengerLocation: window.currentLocation,
        driverLocation: { lat: driver.lat, lng: driver.lng },
        distance: distance,
        price: price
    };

    database.ref('tripRequests').push(tripRequest)
        .then(() => {
            window.selectedDriver = driverId;
            showNotification('ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„', 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø© Ù„Ù„Ø³Ø§Ø¦Ù‚', 'success');
        })
        .catch((error) => {
            showNotification('Ø®Ø·Ø£', 'ÙØ´Ù„ ÙÙŠ Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ Ø§Ù„Ø±Ø­Ù„Ø©: ' + error.message, 'error');
        });
}

</script>

</body>
</html>
